

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.spectrum.formal_integral.formal_integral &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=082ea356"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing Tardis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/spectrum/index.html">Analyzing TARDIS Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/liv_plot_notebook.html">Analyzing Last Interaction Velocity (LIV) Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/rpacket_plot_notebook.html">Analysing Montecarlo Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/analysing_convergence_plot.html">Convergence Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.spectrum.formal_integral.formal_integral</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.spectrum.formal_integral.formal_integral</h1><div class="highlight"><pre>
<span></span>import warnings

import numpy as np
from astropy import units as u
from scipy.interpolate import interp1d

from tardis.model.geometry.radial1d import NumbaRadial1DGeometry
from tardis.opacities.opacity_state import opacity_state_initialize
from tardis.spectrum.formal_integral.formal_integral_cuda import (
    CudaFormalIntegrator,
)
from tardis.spectrum.formal_integral.formal_integral_numba import (
    NumbaFormalIntegrator,
    calculate_p_values,
    trapezoid_integration,
)
from tardis.spectrum.formal_integral.base import (
    check,
    interpolate_integrator_quantities,
)
from tardis.spectrum.formal_integral.source_function import SourceFunctionSolver
from tardis.spectrum.spectrum import TARDISSpectrum


<div class="viewcode-block" id="FormalIntegrator">
<a class="viewcode-back" href="../../../../api/tardis.spectrum.formal_integral.formal_integral.html#tardis.spectrum.formal_integral.formal_integral.FormalIntegrator">[docs]</a>
class FormalIntegrator:
    &quot;&quot;&quot;
    Class containing the formal integrator.

    If there is a NVIDIA CUDA GPU available,
    the formal integral will automatically run
    on it. If multiple GPUs are available, it will
    choose the first one that it sees. You can
    read more about selecting different GPUs on
    Numba&#39;s CUDA documentation.

    Parameters
    ----------
    model : tardis.model.SimulationState
    plasma : tardis.plasma.BasePlasma
    transport : tardis.transport.montecarlo.MontecarloTransport
    points : int64
    &quot;&quot;&quot;

    def __init__(
        self,
        simulation_state,
        plasma,
        transport,
        opacity_state=None,
        macro_atom_state=None,
        points=1000,
    ):
        self.simulation_state = simulation_state
        self.transport = transport
        self.points = points
        if transport:
            self.montecarlo_configuration = (
                self.transport.montecarlo_configuration
            )
        if plasma and opacity_state and macro_atom_state:
            self.opacity_state = opacity_state.to_numba(
                macro_atom_state,
                transport.line_interaction_type,
            )
            self.atomic_data = plasma.atomic_data
            self.plasma = plasma
            self.levels_index = plasma.levels
        elif plasma:
            self.opacity_state = opacity_state_initialize(
                plasma,
                transport.line_interaction_type,
                self.montecarlo_configuration.DISABLE_LINE_SCATTERING,
            )
            self.atomic_data = plasma.atomic_data
            self.plasma = plasma
            self.levels_index = plasma.levels
        else:
            self.opacity_state = None

<div class="viewcode-block" id="FormalIntegrator.generate_numba_objects">
<a class="viewcode-back" href="../../../../api/tardis.spectrum.formal_integral.formal_integral.html#tardis.spectrum.formal_integral.formal_integral.FormalIntegrator.generate_numba_objects">[docs]</a>
    def generate_numba_objects(self):
        &quot;&quot;&quot;
        Instantiate the numba interface objects
        needed for computing the formal integral
        &quot;&quot;&quot;

        self.numba_radial_1d_geometry = NumbaRadial1DGeometry(
            self.transport.r_inner_i,
            self.transport.r_outer_i,
            self.transport.r_inner_i
            / self.simulation_state.time_explosion.to(&quot;s&quot;).value,
            self.transport.r_outer_i
            / self.simulation_state.time_explosion.to(&quot;s&quot;).value,
        )
        if self.opacity_state is None:
            self.opacity_state = opacity_state_initialize(
                self.plasma,
                self.transport.line_interaction_type,
                self.montecarlo_configuration.DISABLE_LINE_SCATTERING,
            )
        if self.transport.use_gpu:
            self.integrator = CudaFormalIntegrator(
                self.numba_radial_1d_geometry,
                self.simulation_state.time_explosion.cgs.value,
                self.opacity_state,
                self.points,
            )
        else:
            self.integrator = NumbaFormalIntegrator(
                self.numba_radial_1d_geometry,
                self.simulation_state.time_explosion.cgs.value,
                self.opacity_state,
                self.points,
            )</div>


<div class="viewcode-block" id="FormalIntegrator.calculate_spectrum">
<a class="viewcode-back" href="../../../../api/tardis.spectrum.formal_integral.formal_integral.html#tardis.spectrum.formal_integral.formal_integral.FormalIntegrator.calculate_spectrum">[docs]</a>
    def calculate_spectrum(
        self, frequency, points=None, interpolate_shells=0, raises=True
    ):
        # Very crude implementation
        # The c extension needs bin centers (or something similar)
        # while TARDISSpectrum needs bin edges
        check(self.simulation_state, self.plasma, self.transport, raises=raises)
        N = points or self.points
        if interpolate_shells == 0:  # Default Value
            interpolate_shells = max(2 * self.simulation_state.no_of_shells, 80)
            warnings.warn(
                &quot;The number of interpolate_shells was not &quot;
                f&quot;specified. The value was set to {interpolate_shells}.&quot;
            )
        self.interpolate_shells = interpolate_shells
        frequency = frequency.to(&quot;Hz&quot;, u.spectral())

        luminosity = u.Quantity(self.formal_integral(frequency, N), &quot;erg&quot;) * (
            frequency[1] - frequency[0]
        )

        # Ugly hack to convert to &#39;bin edges&#39;
        frequency = u.Quantity(
            np.concatenate(
                [
                    frequency.value,
                    [frequency.value[-1] + np.diff(frequency.value)[-1]],
                ]
            ),
            frequency.unit,
        )

        return TARDISSpectrum(frequency, luminosity)</div>


<div class="viewcode-block" id="FormalIntegrator.formal_integral">
<a class="viewcode-back" href="../../../../api/tardis.spectrum.formal_integral.formal_integral.html#tardis.spectrum.formal_integral.formal_integral.FormalIntegrator.formal_integral">[docs]</a>
    def formal_integral(self, nu, N):
        &quot;&quot;&quot;
        Do the formal integral with the numba routines
        &quot;&quot;&quot;
        # TODO: get rid of storage later on

        transport_state = self.transport.transport_state

        source_function_solver = SourceFunctionSolver(
            self.transport.line_interaction_type
        )
        source_function_state = source_function_solver.solve(
            self.simulation_state,
            self.opacity_state,
            transport_state,
            self.atomic_data,
        )

        if self.interpolate_shells &gt; 0:
            (
                att_S_ul,
                Jred_lu,
                Jblue_lu,
                e_dot_u,
            ) = interpolate_integrator_quantities(
                source_function_state,
                self.interpolate_shells,
                self.simulation_state,
                self.transport,
                self.opacity_state,
                self.plasma.electron_densities,
            )
        else:
            att_S_ul, Jred_lu, Jblue_lu, e_dot_u = (
                source_function_state.att_S_ul,
                source_function_state.Jred_lu,
                source_function_state.Jblue_lu,
                source_function_state.e_dot_u,
            )
            self.transport.r_inner_i = transport_state.geometry_state.r_inner
            self.transport.r_outer_i = transport_state.geometry_state.r_outer
            self.transport.tau_sobolevs_integ = self.opacity_state.tau_sobolev
            self.transport.electron_densities_integ = (
                self.opacity_state.electron_density
            )

        att_S_ul = att_S_ul.flatten(order=&quot;F&quot;)
        Jred_lu = Jred_lu.flatten(order=&quot;F&quot;)
        Jblue_lu = Jblue_lu.flatten(order=&quot;F&quot;)

        self.generate_numba_objects()
        L, I_nu_p = self.integrator.formal_integral(
            self.simulation_state.t_inner,
            nu,
            nu.shape[0],
            att_S_ul,
            Jred_lu,
            Jblue_lu,
            self.transport.tau_sobolevs_integ,
            self.transport.electron_densities_integ,
            N,
        )
        R_max = self.transport.r_outer_i[-1]
        ps = calculate_p_values(R_max, N)[None, :]
        I_nu_p[:, 1:] /= ps[:, 1:]
        self.transport.I_nu_p = I_nu_p
        self.transport.p_rays = ps

        I_nu = self.transport.I_nu_p * ps
        L_test = np.array(
            [
                8
                * np.pi
                * np.pi
                * trapezoid_integration((I_nu)[i, :], R_max / N)
                for i in range(nu.shape[0])
            ]
        )
        error = np.max(np.abs((L_test - L) / L))
        assert error &lt; 1e-7, (
            f&quot;Incorrect I_nu_p values, max relative difference:{error}&quot;
        )

        return np.array(L, np.float64)</div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 06 Aug 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>