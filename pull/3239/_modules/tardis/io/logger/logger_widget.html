

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.io.logger.logger_widget &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=c15f583c"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/high_energy/run_high_energy_workflow.html">TARDIS High Energy Workflow Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/tutorial_montecarlo_packet_visualization.html">Montecarlo Packet Visualization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/index.html">Analyszing TARDIS Simulation Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/tutorial_read_configuration.html">Reading a Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to/code_comparison/index.html">How to do Code Comparison using TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/visualization_reference.html">Visualization Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5) Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">Bibliography and Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.io.logger.logger_widget</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.io.logger.logger_widget</h1><div class="highlight"><pre>
<span></span>import logging
import re
import pandas as pd
from tardis.util.environment import Environment
import panel as pn

import tardis.util.panel_init as panel_init
panel_init.auto()


<div class="viewcode-block" id="create_logger_columns">
<a class="viewcode-back" href="../../../../api/tardis.io.logger.logger_widget.html#tardis.io.logger.logger_widget.create_logger_columns">[docs]</a>
def create_logger_columns(start_height=10, max_height=300):
    &quot;&quot;&quot;Create a single logger scroll column with dynamic height.
    
    Returns
    -------
    dict
        Dictionary containing a single log column for all logs.
    &quot;&quot;&quot;
    # Create single scroll column for all logs
    columns = {}
    
    column = pn.pane.HTML(
        &quot;&quot;,
        height=10,  # Start small
        styles={
            &#39;border&#39;: &#39;1px solid #ddd&#39;,
            &#39;background-color&#39;: &#39;white&#39;,
            &#39;overflow-y&#39;: &#39;auto&#39;,
            &#39;overflow-x&#39;: &#39;auto&#39;,
            &#39;font-family&#39;: &#39;monospace&#39;,
            &#39;padding&#39;: &#39;8px&#39;,
            &#39;white-space&#39;: &#39;pre-wrap&#39;
        },
        sizing_mode=&#39;stretch_width&#39;
    )
    column.max_log_entries = 1000
    column._start_height = start_height
    column._max_height = max_height
    column._log_content = &quot;&quot;  # Store content as string
    columns[&quot;ALL&quot;] = column
    
    return columns</div>



<div class="viewcode-block" id="PanelWidgetLogHandler">
<a class="viewcode-back" href="../../../../api/tardis.io.logger.logger_widget.html#tardis.io.logger.logger_widget.PanelWidgetLogHandler">[docs]</a>
class PanelWidgetLogHandler(logging.Handler):
    &quot;&quot;&quot;Log handler for logging to scroll columns.
    
    Parameters
    ----------
    log_columns : dict
        Dictionary of scroll columns for each log level.
    colors : dict
        Dictionary mapping log levels to display colors.
    display_widget : bool, optional
        Whether to display logs in the widget. Defaults to True.
    display_handles : dict, optional
        Dictionary of display handles for each column (jupyter environment).
    &quot;&quot;&quot;
    def __init__(self, log_columns, colors, display_widget=True, display_handles=None, batch_size=10):
        super().__init__()
        self.log_columns = log_columns
        self.colors = colors
        self.display_widget = display_widget
        self.display_handles = display_handles or {}
        self.environment = Environment.get_current_environment()
        
        self.batch_size = batch_size
        self.log_buffers = {&quot;ALL&quot;: []}
        
        self.stream_handler = None
        if not self.display_widget:
            self.stream_handler = logging.StreamHandler()
            self.stream_handler.setFormatter(logging.Formatter(&quot;%(name)s [%(levelname)s] %(message)s (%(filename)s:%(lineno)d)&quot;))

<div class="viewcode-block" id="PanelWidgetLogHandler.emit">
<a class="viewcode-back" href="../../../../api/tardis.io.logger.logger_widget.html#tardis.io.logger.logger_widget.PanelWidgetLogHandler.emit">[docs]</a>
    def emit(self, record):
        &quot;&quot;&quot;Process and emit a log record.
        
        Parameters
        ----------
        record : logging.LogRecord
            The log record to process and display.
        &quot;&quot;&quot;
        if not self.display_widget:
            if self.stream_handler:
                self.stream_handler.emit(record)
            return

        if isinstance(record.msg, pd.DataFrame):
            df_str = record.msg.to_string(index=True)
            html_output = f&#39;&lt;pre style=&quot;white-space: pre; margin: 0;&quot;&gt;{df_str}&lt;/pre&gt;&#39;
        else:
            log_entry = self.format(record)
            clean_log_entry = self._remove_ansi_escape_sequences(log_entry)
            html_output = self._format_html_output(clean_log_entry, record)

        self._emit_to_columns(html_output)</div>


    @staticmethod
    def _remove_ansi_escape_sequences(text):
        &quot;&quot;&quot;Remove ANSI escape sequences from string.
        
        Parameters
        ----------
        text : str
            The text containing ANSI escape sequences.
            
        Returns
        -------
        str
            Cleaned text with ANSI escape sequences removed.
        &quot;&quot;&quot;
        ansi_escape = re.compile(r&quot;\x1B[@-_][0-?]*[ -/]*[@-~]&quot;)
        return ansi_escape.sub(&quot;&quot;, text)

    def _format_html_output(self, log_entry, record):
        &quot;&quot;&quot;Format log entry as HTML with appropriate styling.
        
        Parameters
        ----------
        log_entry : str
            The log entry text to format.
        record : logging.LogRecord
            The log record containing level information.
            
        Returns
        -------
        str
            HTML-formatted log entry.
        &quot;&quot;&quot;
        color = self.colors.get(record.levelno, self.colors[&quot;default&quot;])
        parts = log_entry.split(&quot; &quot;, 2)
        if len(parts) &gt; 2:
            prefix, levelname, message = parts
            return f&#39;&lt;span&gt;{prefix}&lt;/span&gt; &lt;span style=&quot;color: {color}; font-weight: bold;&quot;&gt;{levelname}&lt;/span&gt; {message}&#39;
        return log_entry

    def _emit_to_columns(self, html_output):
        &quot;&quot;&quot;Add log entry to buffer and flush when batch size reached.
        
        Parameters
        ----------
        html_output : str
            The HTML-formatted log message.
        &quot;&quot;&quot;
        # Send all logs to the single &quot;ALL&quot; column
        output_key = &quot;ALL&quot;
        if output_key in self.log_buffers:
            self.log_buffers[output_key].append(html_output)
            
            if len(self.log_buffers[output_key]) &gt;= self.batch_size:
                self._flush_buffer(output_key)
    
    def _flush_buffer(self, output_key):
        &quot;&quot;&quot;Flush buffered logs to column.&quot;&quot;&quot;
        if not self.log_buffers[output_key] or output_key not in self.log_columns:
            return
            
        level_column = self.log_columns[output_key]
        
        # Combine all buffered logs
        batch_html = &#39;&#39;.join([f&quot;&lt;div style=&#39;margin: 2px 0; padding: 2px 0;&#39;&gt;{log}&lt;/div&gt;&quot; for log in self.log_buffers[output_key]])
        current_content = getattr(level_column, &#39;_log_content&#39;, &#39;&#39;) or level_column.object or &#39;&#39;
        new_content = current_content + batch_html if current_content else batch_html
        
        # Store content and update column
        level_column._log_content = new_content
        level_column.object = new_content
        
        # Dynamic height adjustment
        self._adjust_column_height(level_column, new_content)
        
        # Trim old entries if needed
        if new_content.count(&#39;&lt;div&#39;) &gt; level_column.max_log_entries:
            divs = new_content.split(&#39;&lt;div&#39;)
            trimmed = &#39;&lt;div&#39;.join(divs[-level_column.max_log_entries:])
            level_column._log_content = trimmed
            level_column.object = trimmed
        
        # Update display handle
        if ((self.environment == &#39;jupyter&#39; or self.environment == &#39;ssh_jh&#39;) and output_key in self.display_handles 
            and self.display_handles[output_key] is not None):
            self.display_handles[output_key].update(level_column)
            
        # Clear buffer
        self.log_buffers[output_key] = []
    
    def _adjust_column_height(self, column, content=None):
        &quot;&quot;&quot;Dynamically adjust column height based on content.
        
        Parameters
        ----------
        column : panel.pane.HTML
            The column to adjust.
        content : str, optional
            The content to count entries from. If None, uses column._log_content.
        &quot;&quot;&quot;
        if hasattr(column, &#39;_start_height&#39;) and hasattr(column, &#39;_max_height&#39;):
            # Count entries by counting divs in content
            if content is None:
                content = getattr(column, &#39;_log_content&#39;, &#39;&#39;) or column.object or &#39;&#39;
            entry_count = content.count(&#39;&lt;div&#39;) if content else 0
            
            # Estimate height needed: ~25px per log entry
            estimated_height = max(column._start_height, entry_count * 25)
            # Cap at max height
            new_height = min(estimated_height, column._max_height)
            column.height = new_height
    
<div class="viewcode-block" id="PanelWidgetLogHandler.close">
<a class="viewcode-back" href="../../../../api/tardis.io.logger.logger_widget.html#tardis.io.logger.logger_widget.PanelWidgetLogHandler.close">[docs]</a>
    def close(self):
        &quot;&quot;&quot;Close the log handler.
        &quot;&quot;&quot;
        # Flush any remaining buffered logs
        for output_key in self.log_buffers:
            if self.log_buffers[output_key]:
                self._flush_buffer(output_key)
        
        super().close()
        if self.stream_handler:
            self.stream_handler.flush()
            self.stream_handler.close()
            self.stream_handler = None</div>
</div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 17 Aug 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>